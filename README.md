# Telegram AI Bot

Персональный AI-ассистент в Telegram на базе OpenAI-совместимых моделей.

## Возможности

- **Чат с AI** — диалог с контекстом, поддержка нескольких параллельных бесед, выбор модели
- **Голосовые сообщения** — распознавание речи (Whisper) и озвучка ответов (TTS)
- **Анализ изображений** — отправьте фото, и бот опишет / ответит на вопрос по нему
- **Генерация изображений** — создание картинок по текстовому описанию (DALL-E / gpt-image)
- **Веб-поиск** — бот сам решает, когда нужен поиск, или можно запросить явно
- **Суммаризация ссылок** — отправьте URL, и бот сделает краткое изложение страницы
- **Напоминания** — отложенные уведомления с поддержкой русского и английского формата времени
- **Память** — бот запоминает факты о пользователе между беседами
- **Google Календарь** — просмотр и создание событий, ежедневный дайджест с погодой
- **Финансы** — учёт расходов по неделям/годам, бюджет, графики, экспорт CSV
- **Новости** — RSS-агрегатор с персонализацией по реакциям
- **Погода** — прогноз на 5 дней с графиком
- **Навыки (Skills)** — расширяемая система плагинов (калькулятор, дата/время, выполнение кода)
- **VPS-мониторинг** — SSH-опрос серверов, алерты, Docker-контейнеры, графики метрик
- **Администрирование** — одобрение пользователей, статистика, баны, рассылка

## Команды бота

### Чат

| Команда | Описание |
|---|---|
| `/start` | Запуск бота |
| `/help` | Список команд |
| `/reset` | Новый диалог |
| `/conversations` | Список диалогов, переключение между ними |
| `/history` | Последние сообщения |
| `/export` | Экспорт диалога в файл (txt + json) |
| `/model` | Выбор модели (интерактивные кнопки) |
| `/system <prompt>` | Установить системный промпт |

### Инструменты

| Команда | Описание |
|---|---|
| `/image <описание>` | Генерация изображения |
| `/search <запрос>` | Веб-поиск с ответом AI |
| `/sum <url>` | Краткое изложение страницы |
| `/weather` | Погода и прогноз на 5 дней |
| `/usage` | Статистика использования токенов |

### Напоминания

| Команда | Описание |
|---|---|
| `/remind <когда> <что>` | Установить напоминание |
| `/reminders` | Список активных напоминаний |
| `/delremind <id>` | Удалить напоминание |

### Память

| Команда | Описание |
|---|---|
| `/memory` | Что бот помнит о вас |
| `/remember <факт>` | Сохранить факт |
| `/forget <id>` | Удалить факт |
| `/forget_all` | Очистить всю память |

### Google Календарь

| Команда | Описание |
|---|---|
| `/gcal` | События на сегодня |
| `/gcal_tomorrow` | События на завтра |
| `/gcal_week` | События на неделю |
| `/gcal_calendars` | Список подключённых календарей |
| `/gcal add <дата> <время> <текст>` | Добавить событие |
| `/gcal del <id>` | Удалить событие |

### Финансы

| Команда | Описание |
|---|---|
| `/exp` | Добавить расход |
| `/exp_latest` | Последние 10 записей |
| `/delexp <id>` | Удалить запись |
| `/week [N]` | Статистика за N-ю неделю + график |
| `/year [YYYY]` | Статистика за год + график |
| `/budget <сумма>` | Установить недельный бюджет |
| `/budget_list` | История бюджета |
| `/newweek` | Новая финансовая неделя |
| `/fexport` | Экспорт расходов в CSV |

### Новости

| Команда | Описание |
|---|---|
| `/news` | Свежие статьи из RSS-источников |
| `/news_add <url>` | Добавить RSS-источник |
| `/news_sources` | Список источников |
| `/news_remove <id>` | Удалить источник |

### Навыки

| Команда | Описание |
|---|---|
| `/skills` | Список установленных навыков |
| `/calc` | Калькулятор |
| `/time` | Текущее время |
| `/run` | Выполнение кода |
| `/translate` | Перевести текст |
| `/summarize` | Суммаризация текста |

### VPS-мониторинг (только для админа)

| Команда | Описание |
|---|---|
| `/vps` | Сводка по всем серверам (CPU / RAM / Disk / контейнеры) |
| `/vps <alias>` | Детальный статус + график CPU/RAM/Disk за 24ч |
| `/vps add <alias> <host> <user> [port]` | Добавить сервер |
| `/vps remove <alias>` | Удалить сервер |
| `/vps exec <alias> <команда>` | Выполнить команду по SSH |

Мониторинг опрашивает серверы каждые 5 минут и присылает алерты при:
- недоступности сервера
- CPU > 85%, RAM > 90%, Disk > 90%
- переходе контейнера из `running` → `exited`

### Администрирование

| Команда | Описание |
|---|---|
| `/admin` | Список всех пользователей |
| `/stats <user_id>` | Детальная статистика пользователя |
| `/ban <user_id>` | Заблокировать пользователя |
| `/unban <user_id>` | Разблокировать пользователя |
| `/broadcast <текст>` | Рассылка всем пользователям |

## Запуск

### Подготовка

1. Скопируйте файл окружения и заполните его:

```bash
cp .env.example .env
```

Обязательные переменные:

| Переменная | Описание |
|---|---|
| `TELEGRAM_BOT_TOKEN` | Токен бота от [@BotFather](https://t.me/BotFather) |
| `OPENAI_API_KEY` | Ключ API OpenAI |

Опциональные:

| Переменная | По умолчанию | Описание |
|---|---|---|
| `OPENAI_BASE_URL` | `https://api.openai.com/v1` | URL API (для совместимых провайдеров) |
| `DEFAULT_MODEL` | `gpt-4o` | Модель по умолчанию |
| `AVAILABLE_MODELS` | — | Список моделей через запятую |
| `MAX_CONTEXT_MESSAGES` | `50` | Макс. сообщений в контексте |
| `MAX_CONTEXT_TOKENS` | `8000` | Макс. токенов в контексте |
| `ALLOWED_USERS` | — | ID разрешённых пользователей через запятую |
| `ADMIN_ID` | — | ID администратора |
| `DAILY_TOKEN_LIMIT` | `0` (без лимита) | Дневной лимит токенов |
| `MONTHLY_TOKEN_LIMIT` | `0` (без лимита) | Месячный лимит токенов |
| `WHISPER_MODEL` | `whisper-1` | Модель распознавания речи |
| `IMAGE_MODEL` | `dall-e-3` | Модель генерации изображений |
| `DB_PATH` | `/data/bot.db` | Путь к базе данных |
| `GEMINI_API_KEY` | — | Ключи Gemini через запятую (primary LLM) |
| `GEMINI_MODEL` | `gemini-2.5-flash` | Модель Gemini |
| `GOOGLE_CREDENTIALS_PATH` | — | Путь к credentials.json для Google Calendar |
| `GOOGLE_CALENDAR_ID` | — | ID основного Google Календаря |
| `TIMEZONE` | `UTC` | Часовой пояс (например `Europe/Moscow`) |
| `GCAL_DAILY_HOUR` | `8` | Час ежедневного дайджеста |
| `WEATHER_LAT` / `WEATHER_LON` | — | Координаты для погоды |
| `WEATHER_CITY` | `Челябинск` | Название города в сводке |
| `VPS_SSH_KEY_PATH` | `/data/keys/monitor_id_ed25519` | Путь к SSH-ключу для мониторинга |
| `VPS_CPU_THRESHOLD` | `85.0` | Порог CPU для алерта (%) |
| `VPS_MEM_THRESHOLD` | `90.0` | Порог RAM для алерта (%) |
| `VPS_DISK_THRESHOLD` | `90.0` | Порог Disk для алерта (%) |
| `VPS_POLL_INTERVAL` | `300` | Интервал опроса серверов (секунды) |

### Docker Compose (готовый образ с GitHub)

```bash
docker compose pull
docker compose up -d
```

Обновление до последней версии:

```bash
docker compose pull && docker compose up -d
```

### VPS-мониторинг — настройка SSH-ключа

```bash
# Создать папку keys рядом с docker-compose.yml
mkdir -p keys

# Сгенерировать ключ специально для бота
ssh-keygen -t ed25519 -f keys/monitor_id_ed25519 -N ""

# Скопировать публичный ключ на каждый сервер
ssh-copy-id -i keys/monitor_id_ed25519.pub user@host

# Если нужен мониторинг Docker-контейнеров — добавить пользователя в группу docker
ssh user@host "sudo usermod -aG docker user"
```

После запуска добавить сервер в боте:
```
/vps add myserver 1.2.3.4 user
```

### Docker (ручной запуск)

```bash
docker run -d \
  --name telegram-bot \
  --restart unless-stopped \
  --env-file .env \
  -v bot-data:/data \
  ghcr.io/zlobnoe/telegram_bot:latest
```

### Локальная сборка

Если нужно собрать образ самостоятельно:

```bash
docker build -t telegram-bot .
docker run -d \
  --name telegram-bot \
  --restart unless-stopped \
  --env-file .env \
  -v bot-data:/data \
  telegram-bot
```

### Без Docker

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m bot.main
```

## CI/CD

При пуше в `main` или создании тега `v*` автоматически собирается Docker-образ для `linux/amd64` и `linux/arm64` и публикуется в GitHub Container Registry (`ghcr.io`).

Теги образов:
- `latest` — последняя версия из ветки `main`
- `v1.0.0` — версия по git-тегу
- `abc1234` — по SHA коммита
