# Telegram AI Bot

Персональный AI-ассистент в Telegram на базе OpenAI-совместимых моделей.

## Возможности

- **Чат с AI** — диалог с контекстом, поддержка нескольких параллельных бесед, выбор модели
- **Голосовые сообщения** — распознавание речи (Whisper) и озвучка ответов (TTS)
- **Анализ изображений** — отправьте фото, и бот опишет / ответит на вопрос по нему
- **Генерация изображений** — создание картинок по текстовому описанию (DALL-E / gpt-image)
- **Веб-поиск** — бот сам решает, когда нужен поиск, или можно запросить явно
- **Суммаризация ссылок** — отправьте URL, и бот сделает краткое изложение страницы
- **Напоминания** — отложенные уведомления с поддержкой русского и английского формата времени
- **Память** — бот запоминает факты о пользователе между беседами
- **Навыки (Skills)** — расширяемая система плагинов (калькулятор, дата/время, выполнение кода)
- **Администрирование** — одобрение пользователей, статистика, баны, рассылка

## Команды бота

### Чат

| Команда | Описание |
|---|---|
| `/start` | Запуск бота |
| `/help` | Список команд |
| `/reset` | Новый диалог |
| `/conversations` | Список диалогов, переключение между ними |
| `/history` | Последние сообщения |
| `/export` | Экспорт диалога в файл (txt + json) |
| `/model` | Выбор модели (интерактивные кнопки) |
| `/system <prompt>` | Установить системный промпт |

### Инструменты

| Команда | Описание |
|---|---|
| `/image <описание>` | Генерация изображения |
| `/search <запрос>` | Веб-поиск с ответом AI |
| `/sum <url>` | Краткое изложение страницы |
| `/usage` | Статистика использования токенов |

### Напоминания

| Команда | Описание |
|---|---|
| `/remind <когда> <что>` | Установить напоминание |
| `/reminders` | Список активных напоминаний |
| `/delremind <id>` | Удалить напоминание |

### Память

| Команда | Описание |
|---|---|
| `/memory` | Что бот помнит о вас |
| `/remember <факт>` | Сохранить факт |
| `/forget <id>` | Удалить факт |
| `/forget_all` | Очистить всю память |

### Навыки

| Команда | Описание |
|---|---|
| `/skills` | Список установленных навыков |
| `/calc` | Калькулятор |
| `/time` | Текущее время |
| `/run` | Выполнение кода |

### Администрирование

| Команда | Описание |
|---|---|
| `/admin` | Список всех пользователей |
| `/stats <user_id>` | Детальная статистика пользователя |
| `/ban <user_id>` | Заблокировать пользователя |
| `/unban <user_id>` | Разблокировать пользователя |
| `/broadcast <текст>` | Рассылка всем пользователям |

## Запуск

### Подготовка

1. Скопируйте файл окружения и заполните его:

```bash
cp .env.example .env
```

Обязательные переменные:

| Переменная | Описание |
|---|---|
| `TELEGRAM_BOT_TOKEN` | Токен бота от [@BotFather](https://t.me/BotFather) |
| `OPENAI_API_KEY` | Ключ API OpenAI |

Опциональные:

| Переменная | По умолчанию | Описание |
|---|---|---|
| `OPENAI_BASE_URL` | `https://api.openai.com/v1` | URL API (для совместимых провайдеров) |
| `DEFAULT_MODEL` | `gpt-4o` | Модель по умолчанию |
| `AVAILABLE_MODELS` | — | Список моделей через запятую |
| `MAX_CONTEXT_MESSAGES` | `50` | Макс. сообщений в контексте |
| `MAX_CONTEXT_TOKENS` | `8000` | Макс. токенов в контексте |
| `ALLOWED_USERS` | — | ID разрешённых пользователей через запятую |
| `ADMIN_ID` | — | ID администратора |
| `DAILY_TOKEN_LIMIT` | `0` (без лимита) | Дневной лимит токенов |
| `MONTHLY_TOKEN_LIMIT` | `0` (без лимита) | Месячный лимит токенов |
| `WHISPER_MODEL` | `whisper-1` | Модель распознавания речи |
| `IMAGE_MODEL` | `dall-e-3` | Модель генерации изображений |
| `DB_PATH` | `/data/bot.db` | Путь к базе данных |

### Docker Compose (готовый образ с GitHub)

```bash
docker compose pull
docker compose up -d
```

Обновление до последней версии:

```bash
docker compose pull && docker compose up -d
```

### Docker (ручной запуск)

```bash
docker run -d \
  --name telegram-bot \
  --restart unless-stopped \
  --env-file .env \
  -v bot-data:/data \
  ghcr.io/zlobnoe/telegram_bot:latest
```

### Локальная сборка

Если нужно собрать образ самостоятельно:

```bash
docker build -t telegram-bot .
docker run -d \
  --name telegram-bot \
  --restart unless-stopped \
  --env-file .env \
  -v bot-data:/data \
  telegram-bot
```

### Без Docker

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m bot.main
```

## CI/CD

При пуше в `main` или создании тега `v*` автоматически собирается Docker-образ и публикуется в GitHub Container Registry (`ghcr.io`).

Теги образов:
- `latest` — последняя версия из ветки `main`
- `v1.0.0` — версия по git-тегу
- `abc1234` — по SHA коммита
